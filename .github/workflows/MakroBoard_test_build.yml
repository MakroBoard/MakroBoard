name: MakroBoard_test_build

on:
  push:
    branches: [ main ]
    tags: [ v**]
    paths:
    - '**'
    - '!Docs/**'
    - '!README.md'
    - '!.github/MakroBoard_website_build.yml'
  pull_request:
    branches: [ main ]
    tags: [ v**]
    paths:
    - '**'
    - '!Docs/**'
    - '!README.md'
    - '!.github/MakroBoard_website_build.yml'

jobs:

  build_linux:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Import GPG key
      id: import_gpg
      uses: crazy-max/ghaction-import-gpg@v3
      with:
        gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
    - name: GPG user IDs
      run: |
        echo "fingerprint: ${{ steps.import_gpg.outputs.fingerprint }}"
        echo "keyid:       ${{ steps.import_gpg.outputs.keyid }}"
        echo "name:        ${{ steps.import_gpg.outputs.name }}"
        echo "email:       ${{ steps.import_gpg.outputs.email }}"
    - uses: actions/setup-java@v1
      with:
        java-version: '12.x'
    - uses: subosito/flutter-action@v1
      with:
        flutter-version: '2.0.4'
    - uses: actions/checkout@v2
    - name: Setup .NET
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 5.0.x
    - name: Setup Android SDK
      uses: android-actions/setup-android@v2
    - name: Setup cmake
      uses: jwlawson/actions-setup-cmake@v1.8
      with:
        cmake-version: '3.16'
    - name: Install apt dependencies
      run: sudo apt-get update && sudo apt-get install libidn11 jq curl wget ninja-build clang pkg-config cmake-data libblkid-dev libgtk-3-dev liblzma-dev flatpak -y
    - name: install appimagekit
      run: wget $(curl -sL https://api.github.com/repos/AppImage/AppImageKit/releases/latest | jq -r '.assets[].browser_download_url' | grep "appimagetool-x86_64.AppImage$") && chmod +x appimagetool-x86_64.AppImage
    - name: flutter get dependencies
      working-directory: ./makro_board_client    
      run: flutter pub get
    - name: flutter build apk 
      working-directory: ./makro_board_client    
      run: flutter build apk --release 
    - name: flutter build web
      working-directory: ./makro_board_client    
      run: flutter build web
    - name: flutter config linux
      working-directory: ./makro_board_client    
      run: flutter config --enable-linux-desktop 
    - name: flutter build linux
      working-directory: ./makro_board_client    
      run: flutter build linux --release   
    - name: Restore dependencies
      run: dotnet restore
    - name: copy web to dotnet
      run: cp -rf ./makro_board_client/build/web/* ./MakroBoard/wwwroot/
    - name: Build linux dotnet
      run: dotnet publish -r linux-x64 -c release

    - name: prepare appimage linxuclient x64 dir
      run: mkdir -p ./appimage/MakroBoard_client_x64.AppDir &&  cp -rf ./makro_board_client/build/linux/release/bundle/* ./appimage/MakroBoard_client_x64.AppDir/ && cp ./packaging/AppImage/linuxclient_Apprun ./appimage/MakroBoard_client_x64.AppDir/AppRun && chmod +x ./appimage/MakroBoard_client_x64.AppDir/AppRun && cp ./packaging/logo.png ./appimage/MakroBoard_client_x64.AppDir/MakroBoardClient.png && cp ./packaging/AppImage/linuxclient_desktop ./appimage/MakroBoard_client_x64.AppDir/MakroBoard_client_x64.desktop 
    - name: build appimage linuxclient x64
      # run: ./appimagetool-x86_64.AppImage ./appimage/MakroBoard_client_x64.AppDir/ MakroBoard_client_x64.AppImage
      run: ./appimagetool-x86_64.AppImage ./appimage/MakroBoard_client_x64.AppDir/ MakroBoard_client_x64.AppImage --sign


    - name: prepare appimage linxhost x64 dir
      run: mkdir -p ./appimage/MakroBoard_host_x64.AppDir &&  cp -rf ./MakroBoard/bin/Release/net5.0/linux-x64/publish/* ./appimage/MakroBoard_host_x64.AppDir/ && cp ./packaging/AppImage/linuxhost_Apprun ./appimage/MakroBoard_host_x64.AppDir/AppRun && chmod +x ./appimage/MakroBoard_host_x64.AppDir/AppRun && cp ./packaging/logo.png ./appimage/MakroBoard_host_x64.AppDir/MakroBoardHost.png && cp ./packaging/AppImage/linuxhost_desktop ./appimage/MakroBoard_host_x64.AppDir/MakroBoard_host_x64.desktop
    - name: build appimage linuxhost x64
      # run: ./appimagetool-x86_64.AppImage ./appimage/MakroBoard_host_x64.AppDir/ MakroBoard_host_x64.AppImage
      run: ./appimagetool-x86_64.AppImage ./appimage/MakroBoard_host_x64.AppDir/ MakroBoard_host_x64.AppImage --sign


    - name: make upload folders
      run: mkdir upload && mkdir upload/linuxhost_x64 && mkdir upload/linuxclient_x64 && mkdir upload/linuxclient_appimage_x64 && mkdir upload/linuxhost_appimage_x64 && mkdir upload/web && mkdir upload/android 
    - name: copy linux client x64
      run: cp -rf ./makro_board_client/build/linux/release/bundle/* upload/linuxclient_x64/ 
    - name: copy linux client appimage x64  
      run: cp -rf MakroBoard_client_x64.AppImage* upload/linuxclient_appimage_x64/ 
    - name: copy linux host appimage x64  
      run: cp -rf MakroBoard_host_x64.AppImage* upload/linuxhost_appimage_x64/
    - name: copy linux Host x64
      run: cp -rf ./MakroBoard/bin/Release/net5.0/linux-x64/publish/* upload/linuxhost_x64/
    - name: copy webapp
      run: cp -rf ./makro_board_client/build/web/* upload/web/
    - name: copy android
      run: cp -rf ./makro_board_client/build/app/outputs/flutter-apk/* upload/android/
    - name: find uploads
      run: find upload/
    - name: ul temp
      if: ${{ env.ACT }}
      run: curl -Ffile=@MakroBoard_client_x64.AppImage 'http://10.10.10.225:25478/upload?token=HALLO123456'  
    - name: ul temp 2
      if: ${{ env.ACT }}
      run: curl -Ffile=@MakroBoard_host_x64.AppImage 'http://10.10.10.225:25478/upload?token=HALLO123456'
    - uses: actions/upload-artifact@v2
      if: ${{ !env.ACT }}
      with:
        name: latest
        path: upload/


  # build_windows:
  #   runs-on: windows-2019
  #   steps:
  #   - uses: actions/checkout@v2
  #     with:
  #       repository: flutter/flutter
  #       ref: master
  #   - name: Setup .NET
  #     uses: actions/setup-dotnet@v1
  #     with:
  #       dotnet-version: 5.0.x
  #   - name: Add Flutter to path
  #     run: echo "::add-path::$GITHUB_WORKSPACE/flutter/bin"
  #   - name: flutter config windows
  #     run: flutter config --enable-windows-desktop
  #   - name: flutter get dependencies
  #     working-directory: ./makro_board_client    
  #     run: flutter pub get
  #   - name: flutter build windows
  #     working-directory: ./makro_board_client    
  #     run: flutter build windows --release
  #   - name: Restore dependencies
  #     run: dotnet restore
  #   - name: Build Windows dotnet
  #     run: dotnet publish -r win-x64 -c release   


  # build_macos:
  #   runs-on: macos-latest
  #   steps:
  #   - uses: actions/checkout@v2
  #   - uses: actions/setup-java@v1
  #     with:
  #       java-version: '12.x'
  #   - uses: subosito/flutter-action@v1
  #     with:
  #       flutter-version: '1.22.4'
  #   - name: flutter doctor
  #     run: flutter doctor -v
  #   - name: flutter get dependencies
  #     working-directory: ./makro_board_client    
  #     run: flutter pub get
  #   - name: flutter build ios
  #     working-directory: ./makro_board_client    
  #     run: flutter build ios --release --no-codesign      

  #   - name: flutter config macos
  #     working-directory: ./makro_board_client    
  #     run: flutter config --enable-macos-desktop
  #   - name: flutter build macos
  #     working-directory: ./makro_board_client    
  #     run: flutter build macos --release
  #   - name: Restore dependencies
  #     run: dotnet restore
  #   - name: Build mac dotnet
  #     run: dotnet publish -r osx-x64 -c release



#  release:
#     name: Release
#     if: startsWith(github.ref, 'refs/tags/v') && ${{ github.event_name == 'push' }}
#     needs:
#     - build_linux  
#     - build_windows
#     - build_macos
#     runs-on: ubuntu-latest
#     steps:
    


# flatpak for future
#

    # - name: prepare flatpak linuxclient
    #   run: mkdir -p ./flatpakbuild/linuxclient && cp  ./packaging/flatpak/org.wmsk.client.yml ./flatpakbuild/linuxclient/ && cp -rf ./makro_board_client/build/linux/release/bundle/* ./flatpakbuild/linuxclient/
    # - name: build flatpak linuxclient 
    #   run: cd ./flatpakbuild/linuxclien && flatpak-builder build-dir org.wmsk.client.yml
      # - name: install flatpak SDK
      # run:  flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo && flatpak install flathub org.freedesktop.Platform//19.08 org.freedesktop.Sdk//19.08

      #runci!